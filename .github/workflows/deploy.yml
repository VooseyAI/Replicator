name: Deploy to Replicate

on:
  push:
    branches:
      - main
    paths:
      - 'depth-anything-v3/**'
      - 'sam3d-objects/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy-depth-anything:
    name: Deploy Depth Anything V3
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.modified, 'depth-anything-v3/') ||
      contains(github.event.head_commit.added, 'depth-anything-v3/') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Cog
        run: |
          sudo curl -o /usr/local/bin/cog -L "https://github.com/replicate/cog/releases/latest/download/cog_$(uname -s)_$(uname -m)"
          sudo chmod +x /usr/local/bin/cog

      - name: Login to Replicate
        env:
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: |
          echo "" | cog login --token-stdin <<< "$REPLICATE_API_TOKEN"

      - name: Push to Replicate
        working-directory: depth-anything-v3
        env:
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: |
          cog push r8.im/vooseyllc/depth-anything-v3

  deploy-sam3d:
    name: Deploy SAM3D Objects
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.modified, 'sam3d-objects/') ||
      contains(github.event.head_commit.added, 'sam3d-objects/') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Cog
        run: |
          sudo curl -o /usr/local/bin/cog -L "https://github.com/replicate/cog/releases/latest/download/cog_$(uname -s)_$(uname -m)"
          sudo chmod +x /usr/local/bin/cog

      - name: Login to Replicate
        env:
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: |
          echo "" | cog login --token-stdin <<< "$REPLICATE_API_TOKEN"

      - name: Push to Replicate
        working-directory: sam3d-objects
        env:
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: |
          cog push r8.im/vooseyllc/sam3d-objects
